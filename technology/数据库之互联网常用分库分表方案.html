<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库之互联网常用分库分表方案 | 温柔一刀</title>
    <meta name="description" content="">
    <link rel="icon" href="/img/logo.jpeg">
    
    <link rel="preload" href="/assets/css/0.styles.a8fadcfc.css" as="style"><link rel="preload" href="/assets/js/app.3295d756.js" as="script"><link rel="preload" href="/assets/js/8.beb2bf5d.js" as="script"><link rel="preload" href="/assets/js/2.50cffe61.js" as="script"><link rel="prefetch" href="/assets/js/10.38c467ad.js"><link rel="prefetch" href="/assets/js/11.d4321d37.js"><link rel="prefetch" href="/assets/js/12.0aa7141a.js"><link rel="prefetch" href="/assets/js/13.6bb7e66f.js"><link rel="prefetch" href="/assets/js/14.58ed4118.js"><link rel="prefetch" href="/assets/js/15.61ef56ff.js"><link rel="prefetch" href="/assets/js/16.befdde1c.js"><link rel="prefetch" href="/assets/js/17.cf067eab.js"><link rel="prefetch" href="/assets/js/18.53979078.js"><link rel="prefetch" href="/assets/js/19.99855ec8.js"><link rel="prefetch" href="/assets/js/20.9321d797.js"><link rel="prefetch" href="/assets/js/21.302abdf0.js"><link rel="prefetch" href="/assets/js/22.cf1803f0.js"><link rel="prefetch" href="/assets/js/23.9a7e9698.js"><link rel="prefetch" href="/assets/js/24.1916c860.js"><link rel="prefetch" href="/assets/js/3.d4df4c83.js"><link rel="prefetch" href="/assets/js/4.eb49bfe2.js"><link rel="prefetch" href="/assets/js/5.2a57351f.js"><link rel="prefetch" href="/assets/js/6.06fba2c1.js"><link rel="prefetch" href="/assets/js/7.9ad3fe6f.js"><link rel="prefetch" href="/assets/js/9.d959ce65.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a8fadcfc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpeg" alt="温柔一刀" class="logo"> <span class="site-name can-hide">温柔一刀</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/ponder/" class="nav-link">思考</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/share/" class="nav-link">分享</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/5afc74a26f09" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/houliliu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/rea-leaf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav> <div style="margin-left:20px;margin-right:20px;">
   音乐
  <div role="switch" class="el-switch"><input type="checkbox" name="" true-value="true" class="el-switch__input"><!----><span class="el-switch__core" style="width:40px;"></span><!----></div> <audio loop="loop"><source src="/assets/media/love.71191943.mp3" type="audio/mpeg"></audio></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/ponder/" class="nav-link">思考</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/share/" class="nav-link">分享</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/5afc74a26f09" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/houliliu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/rea-leaf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>数据库之互联网常用分库分表方案</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_1-数据库瓶颈" class="sidebar-link">1.数据库瓶颈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#io瓶颈" class="sidebar-link">IO瓶颈</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#cpu瓶颈" class="sidebar-link">CPU瓶颈</a></li></ul></li><li><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_2-分库分表" class="sidebar-link">2.分库分表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#水平分表" class="sidebar-link">水平分表</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#水平分库" class="sidebar-link">水平分库</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#垂直分表" class="sidebar-link">垂直分表</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#垂直分库" class="sidebar-link">垂直分库</a></li></ul></li><li><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_3-分库分表工具" class="sidebar-link">3.分库分表工具</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_4-分库分表步骤" class="sidebar-link">4.分库分表步骤</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_5-分库分表问题" class="sidebar-link">5.分库分表问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_1-非partition-key的查询问题（水平分库分表，拆分策略为常用的hash法）" class="sidebar-link">1. 非partition key的查询问题（水平分库分表，拆分策略为常用的hash法）</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_2-端上除了partition-key不止一个非partition-key作为条件查询" class="sidebar-link">2.端上除了partition key不止一个非partition key作为条件查询</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_3-后台除了partition-key还有各种非partition-key组合条件查询" class="sidebar-link">3.后台除了partition key还有各种非partition key组合条件查询</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_4-非partition-key跨库跨表分页查询问题（水平分库分表，拆分策略为常用的hash法）" class="sidebar-link">4.非partition key跨库跨表分页查询问题（水平分库分表，拆分策略为常用的hash法）</a></li><li class="sidebar-sub-header"><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_5-扩容问题（水平分库分表，拆分策略为常用的hash法）" class="sidebar-link">5.扩容问题（水平分库分表，拆分策略为常用的hash法）</a></li></ul></li><li><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_6-分库分表总结" class="sidebar-link">6.分库分表总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/technology/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%B8%B8%E7%94%A8%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88.html#_7-分库分表实例" class="sidebar-link">7.分库分表实例</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="_1-数据库瓶颈"><a href="#_1-数据库瓶颈" aria-hidden="true" class="header-anchor">#</a> 1.数据库瓶颈</h2> <p>不管是IO瓶颈，还是CPU瓶颈，最终都会导致数据库的活跃连接数增加，进而逼近甚至达到数据库可承载活跃连接数的阈值。在业务Service来看就是，可用数据库连接少甚至无连接可用。接下来就可以想象了吧（并发量、吞吐量、崩溃）。</p> <h3 id="io瓶颈"><a href="#io瓶颈" aria-hidden="true" class="header-anchor">#</a> IO瓶颈</h3> <p>第一种：磁盘读IO瓶颈，热点数据太多，数据库缓存放不下，每次查询时会产生大量的IO，降低查询速度 -&gt; 分库和垂直分表。</p> <p>第二种：网络IO瓶颈，请求的数据太多，网络带宽不够 -&gt; 分库。</p> <h3 id="cpu瓶颈"><a href="#cpu瓶颈" aria-hidden="true" class="header-anchor">#</a> CPU瓶颈</h3> <p>第一种：SQL问题，如SQL中包含join，group by，order by，非索引字段条件查询等，增加CPU运算的操作 -&gt; SQL优化，建立合适的索引，在业务Service层进行业务计算。</p> <p>第二种：单表数据量太大，查询时扫描的行太多，SQL效率低，CPU率先出现瓶颈 -&gt; 水平分表。</p> <h2 id="_2-分库分表"><a href="#_2-分库分表" aria-hidden="true" class="header-anchor">#</a> 2.分库分表</h2> <h3 id="水平分表"><a href="#水平分表" aria-hidden="true" class="header-anchor">#</a> 水平分表</h3> <p><img src="/assets/img/1562479061766.f5b8e0d5.png" alt="水平分表"></p> <ol><li>概念</li></ol> <p>以字段为依据，按照一定策略（hash、range等），将一个表中的数据拆分到多个表中。</p> <ol start="2"><li>结果</li></ol> <ul><li>每个表的结构都是一样</li> <li>每个库的数据不一样，没有交集</li> <li>所有表的并集是全量数据</li></ul> <ol start="3"><li>场景</li></ol> <p>系统绝对并发量并没有上来，只是单表的数据量太多，影响了SQL效率，加重了CPU负担，以至于成为瓶颈。</p> <ol start="4"><li>分析</li></ol> <p>表的数据量少了，单次SQL执行效率高，自然减轻了CPU的负担。</p> <h3 id="水平分库"><a href="#水平分库" aria-hidden="true" class="header-anchor">#</a> 水平分库</h3> <p><img src="/assets/img/1562478410391.3959e895.png" alt="水平分库"></p> <ol><li>概念</li></ol> <p>以字段为依据，按照一定策略（hash、range等），将一个库中的数据拆分到多个库中。</p> <ol start="2"><li>结果</li></ol> <ul><li>每个库的数据库结构都是一样</li> <li>每个库的数据不一样，没有交集</li> <li>所有库的并集是全量数据</li></ul> <ol start="3"><li>场景</li></ol> <p>系统绝对并发量上来了，分表难以根本上解决问题，并且还没有明显的业务归属来垂直分库。</p> <ol start="4"><li>分析</li></ol> <p>库多了，io和cpu的压力自然可以成倍缓解。</p> <h3 id="垂直分表"><a href="#垂直分表" aria-hidden="true" class="header-anchor">#</a> 垂直分表</h3> <p><img src="/assets/img/1562479341375.d97c3dda.png" alt="垂直分表"></p> <ol><li>概念</li></ol> <p>以字段为依据，按照字段的活跃性，将表中字段拆到不同的表（主表和扩展表）中。</p> <ol start="2"><li>结果</li></ol> <ul><li>每个表的结构都不一样；</li> <li>每个表的数据也不一样，一般来说，每个表的字段至少有一列交集，一般是主键，用于关联数据；</li> <li>所有表的并集是全量数据；</li></ul> <ol start="3"><li>场景</li></ol> <p>系统绝对并发量并没有上来，表的记录并不多，但是字段多，并且热点数据和非热点数据在一起，单行数据所需的存储空间较大。以至于数据库缓存的数据行减少，查询时会去读磁盘数据产生大量的随机读IO，产生IO瓶颈。</p> <ol start="4"><li>分析</li></ol> <p>可以用列表页和详情页来帮助理解。垂直分表的拆分原则是将热点数据（可能会冗余经常一起查询的数据）放在一起作为主表，非热点数据放在一起作为扩展表。这样更多的热点数据就能被缓存下来，进而减少了随机读IO。拆了之后，要想获得全部数据就需要关联两个表来取数据。但记住，千万别用join，因为join不仅会增加CPU负担并且会讲两个表耦合在一起（必须在一个数据库实例上）。关联数据，应该在业务Service层做文章，分别获取主表和扩展表数据然后用关联字段关联得到全部数据。</p> <h3 id="垂直分库"><a href="#垂直分库" aria-hidden="true" class="header-anchor">#</a> 垂直分库</h3> <p><img src="/assets/img/1562479236005.e94a1fa2.png" alt="垂直分库"></p> <ol><li>概念</li></ol> <p>以表为依据，按照业务归属不同，将不同的表拆分到不同的库中。</p> <ol start="2"><li>结果</li></ol> <ul><li>每个库的结构都不一样；</li> <li>每个库的数据也不一样，没有交集；</li> <li>所有库的并集是全量数据；</li></ul> <ol start="3"><li>场景</li></ol> <p>系统绝对并发量上来了，并且可以抽象出单独的业务模块。</p> <ol start="4"><li>分析</li></ol> <p>到这一步，基本上就可以服务化了。例如，随着业务的发展一些公用的配置表、字典表等越来越多，这时可以将这些表拆到单独的库中，甚至可以服务化。再有，随着业务的发展孵化出了一套业务模式，这时可以将相关的表拆到单独的库中，甚至可以服务化。</p> <h2 id="_3-分库分表工具"><a href="#_3-分库分表工具" aria-hidden="true" class="header-anchor">#</a> 3.分库分表工具</h2> <ol><li><a href="https://shardingsphere.apache.org/index_zh.html" target="_blank" rel="noopener noreferrer">sharding-sphere<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：jar，前身是sharding-jdbc；</li> <li><a href="http://www.mycat.io/" target="_blank" rel="noopener noreferrer">Mycat<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：中间件。</li></ol> <p>注：工具的利弊，请自行调研，官网和社区优先。</p> <h2 id="_4-分库分表步骤"><a href="#_4-分库分表步骤" aria-hidden="true" class="header-anchor">#</a> 4.分库分表步骤</h2> <p>根据容量（当前容量和增长量）评估分库或分表个数 -&gt; 选key（均匀）-&gt; 分表规则（hash或range等）-&gt; 执行（一般双写）-&gt; 扩容问题（尽量减少数据的移动）。</p> <h2 id="_5-分库分表问题"><a href="#_5-分库分表问题" aria-hidden="true" class="header-anchor">#</a> 5.分库分表问题</h2> <h3 id="_1-非partition-key的查询问题（水平分库分表，拆分策略为常用的hash法）"><a href="#_1-非partition-key的查询问题（水平分库分表，拆分策略为常用的hash法）" aria-hidden="true" class="header-anchor">#</a> 1. 非partition key的查询问题（水平分库分表，拆分策略为常用的hash法）</h3> <h4 id="端上除了partition-key只有一个非partition-key作为条件查询"><a href="#端上除了partition-key只有一个非partition-key作为条件查询" aria-hidden="true" class="header-anchor">#</a> 端上除了partition key只有一个非partition key作为条件查询</h4> <ul><li>映射法
<img src="/assets/img/1562483076698.aeb19d4d.png" alt></li> <li>基因法
<img src="/assets/img/1562487167624.f71c9298.png" alt="enter description here"></li></ul> <p>注：写入时，基因法生成userid，如图。关于xbit基因，例如要分8张表，23=8，故x取3，即3bit基因。根据userid查询时可直接取模路由到对应的分库或分表。根据username查询时，先通过usernamecode生成函数生成username_code再对其取模路由到对应的分库或分表。id生成常用snowflake算法。</p> <h3 id="_2-端上除了partition-key不止一个非partition-key作为条件查询"><a href="#_2-端上除了partition-key不止一个非partition-key作为条件查询" aria-hidden="true" class="header-anchor">#</a> 2.端上除了partition key不止一个非partition key作为条件查询</h3> <ul><li>映射法
<img src="/assets/img/1562487320077.b2cf4e67.png" alt="enter description here"></li> <li>冗余法
<img src="/assets/img/1562487328544.573bfa10.png" alt="enter description here"></li></ul> <p>注：按照orderid或buyerid查询时路由到dbobuyer库中，按照sellerid查询时路由到dbo_seller库中。感觉有点本末倒置！有其他好的办法吗？改变技术栈呢？</p> <h3 id="_3-后台除了partition-key还有各种非partition-key组合条件查询"><a href="#_3-后台除了partition-key还有各种非partition-key组合条件查询" aria-hidden="true" class="header-anchor">#</a> 3.后台除了partition key还有各种非partition key组合条件查询</h3> <ul><li>NoSQL法</li></ul> <p><img src="/assets/img/1562487749628.571afe3a.png" alt="enter description here"></p> <ul><li>冗余法</li></ul> <p><img src="/assets/img/1562487760499.4efd77d1.png" alt="enter description here"></p> <h3 id="_4-非partition-key跨库跨表分页查询问题（水平分库分表，拆分策略为常用的hash法）"><a href="#_4-非partition-key跨库跨表分页查询问题（水平分库分表，拆分策略为常用的hash法）" aria-hidden="true" class="header-anchor">#</a> 4.非partition key跨库跨表分页查询问题（水平分库分表，拆分策略为常用的hash法）</h3> <p>注：用NoSQL法解决（ES等）。</p> <h3 id="_5-扩容问题（水平分库分表，拆分策略为常用的hash法）"><a href="#_5-扩容问题（水平分库分表，拆分策略为常用的hash法）" aria-hidden="true" class="header-anchor">#</a> 5.扩容问题（水平分库分表，拆分策略为常用的hash法）</h3> <ul><li>水平扩容库（升级从库法）</li></ul> <p><img src="/assets/img/1562488029820.d166e23d.png" alt="enter description here"></p> <ul><li>水平扩容表（双写迁移法）</li></ul> <p><img src="/assets/img/1562488043903.94f85546.png" alt="enter description here"></p> <p>第一步：（同步双写）应用配置双写，部署；<br>
第二步：（同步双写）将老库中的老数据复制到新库中；<br>
第三步：（同步双写）以老库为准校对新库中的老数据；<br>
第四步：（同步双写）应用去掉双写，部署；<br>
注：双写是通用方案。</p> <h2 id="_6-分库分表总结"><a href="#_6-分库分表总结" aria-hidden="true" class="header-anchor">#</a> 6.分库分表总结</h2> <ul><li>分库分表，首先得知道瓶颈在哪里，然后才能合理地拆分（分库还是分表？水平还是垂直？分几个？）。且不可为了分库分表而拆分。</li> <li>选key很重要，既要考虑到拆分均匀，也要考虑到非partition key的查询。</li> <li>只要能满足需求，拆分规则越简单越好。</li></ul> <h2 id="_7-分库分表实例"><a href="#_7-分库分表实例" aria-hidden="true" class="header-anchor">#</a> 7.分库分表实例</h2></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间: </span> <span class="time">7/21/2019, 11:47:17 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.3295d756.js" defer></script><script src="/assets/js/8.beb2bf5d.js" defer></script><script src="/assets/js/2.50cffe61.js" defer></script>
  </body>
</html>
